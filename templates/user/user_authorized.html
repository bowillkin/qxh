{% extends "layout.html" %}
{% from "_macro.html" import place_auto_complete_js,assign_log_output %}
{% set category='user' %}
{% block title %}修改客户资料 - {{ user.name }}{% endblock %}
{%- block css -%}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/datetimepicker.css') }}"/>
    <style type="text/css">
        .form-horizontal .control-label {
            float: left;
            width: 95px;
            background-color: #f5f3ef;
            font-weight: bold;
            border: 1px dashed #ccc;
            padding-top: 4px;
            padding-right: 10px;
            padding-bottom: 4px;
            text-align: right;
            color: #777;
            height: 20px;
            font-size: 13px;
        }

        .form-horizontal .controls {
            margin-left: 120px;
        }

        .form-horizontal .control-group {
            margin-bottom: 2px;
        }

        .accordion-group {
            margin-top: 10px;
        }

        .space {
            margin-right: 15px;
            margin-bottom: 10px;
        }

        .accordion-heading {
            background-color: #fcf8e3;
            font-size: 12px;
        }

        .accordion-heading a {
            padding: 0;
            font-weight: bold;
            color: #666;

        }

        .accordion-inner {
            padding-left: 20px;
            padding-bottom: 5px;
            padding-top: 15px;
            background-color: #fcfcfc;
        }

        .entry-group {
            display: block;
            padding: 0px;
        }

        .entry-group-title {
            width: 60px;
            float: left;
            text-align: right;
            padding-right: 5px;

        }

        form hr {
            margin-top: 0px;
            margin-bottom: 15px;
        }

        .accordion-inner table tr td {
            color: #666;
            text-align: left;
        }

        pre {
            margin: 0;
            padding: 0;
            padding-left: 5px;
            background-color: transparent;
            border-width: 0;
            border-left: 4px solid #e0f2be;
        }

        .table tr td {
            font-size: 14px;
            padding:2px 5px 5px 0;
        }

        .table th {
            background-color: #f7f7f7;
        }

        .table-entries {
            font-size: 12px;
        }

        .delete {
            font-weight: bold;
            font-size: 18px;
            color: #000000;
        }

        .form-actions {
            background-color: #ffffff;
            border-top: 1px dashed #eee;
        }

        .say{
            width: 420px;
            max-width: 520px;
        }


        .menubar{
            text-align: right;
            background-image: -webkit-gradient(linear, 0 0, 0 100%, from(#f1f1f1), to(#ffffff));
            height: 85px;
            margin-bottom: 150px;
        }

        .menubar .btn{
            margin-right: 10px;
        }

    </style>
    <style type="text/css">
        .form-horizontal .control-label {
            float: left;
            width: 100px;
            background-color: #f9f9f9;
            padding-top: 5px;
            padding-right: 10px;
            padding-bottom: 5px;
            text-align: right;
            border-bottom: 1px solid #eeeeee;
            border-right: 1px solid #eeeeee;
        }

        .form-horizontal .controls {
            margin-left: 130px;
        }

        .controls ul li{
            margin-right: 20px;
        }

        .perm-title{
            border: 1px solid #ddd;
            background-color: #f0ede7;
            padding-left: 25px;
            padding-top: 5px;
            height: 25px;
        }
        .perm-title label{
            font-weight: bold;
        }

    </style>
    <style type="text/css">
        .selection{
            width:10px;
            height:10px;
            float:left;
            margin-top:4px;
            margin-right:3px;
            border-radius:5px;
        }

        .mystyle_btn{
            margin-left:5%;
            margin-top:5px;
            margin-bottom:-15px;
        }

        #improve{
            width:10px;
            height:10px;
            background-color:#bec3c7;
            float:right;
            margin-top:5px;
        }

        .symptom_td{      
            float:left;
            border:1px solid #bec3c7;
            cursor:pointer;
            padding: 2px 2px 2px 2px;
        }

    </style>
{%- endblock %}

{% block js -%}
{{ super() }}
<script type="text/javascript" src="{{ url_for('static', filename='js/address.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/media.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/bootstrap-inputmask.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/bootstrap-datetimepicker.min.js') }}"
        charset="UTF-8"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/locales/bootstrap-datetimepicker.zh-CN.js') }}"
        charset="UTF-8"></script>
<script type="text/javascript">
    var syms = []
    var improve_syms = []
    function td_click(symptom){
        var s = "#selection_"+ symptom;
        var click_status = $("#selection_input_"+symptom).val();
        if(click_status=='1'){
            var improve_status = $(".improve_"+symptom).css('display');
            if(improve_status!='none'){
                $(s).css({'background-color':''});
                $("#selection_input_"+symptom).val('0');
                alert('该症状已改善');
                var sub =  contains(syms,symptom)
                if(contains(syms,symptom)>=0){
                    syms.splice(sub,1);
                }
                if(contains(improve_syms,symptom)<0){
                   improve_syms.push(symptom);
                   }
                $('.improve_symptoms').val(improve_syms);
            }
        }
        if(click_status=='0'){
            $(s).css({'background-color':'green'});
            $("#selection_input_"+symptom).val('1');
            syms.push(symptom);
        }
        $('.symptoms').val(syms);
    };

    {% if user.orgin_new %}
        {% for key in user.orgin_new %}
            syms.push('{{ key }}');
            $('#selection_{{key}}').css({'background-color':'green'});
            $('#selection_input_{{key}}').val('1');
        {% endfor %}
    {% endif %}

    {% if user.orgin_improve %}
        {% for key in user.orgin_improve %}
            improve_syms.push('{{ key }}');
            $('#symptom_td_{{key}}').css({'background-color':'#fff3ee'})
        {% endfor %}
    {% endif %}


    function resets(){
        var improve_hidden = $('.improve_hidden').val();
        var resets_hidden = $('.resets_hidden').val();
        if(improve_hidden=='1'){
            alert('正在改善用户身体资料中~');
        }else{
            $('.symptom_td').attr({'onclick':''});   <!-- 清空所有td的点击事件 -->
            if(resets_hidden=='1'){
                 $('.resets_hidden').val('0');
                 $('#set_status').text('')
                 {% for module_keys in perms_au %}
                     {% for symptom_keys in perms_au[module_keys]  %}
                         {% for symptom_key in symptom_keys  %}
                             {% for symptom in symptom_keys[symptom_key][0]  %}
                                 $('#symptom_td_{{symptom}}').attr({'onclick':"td_click('{{symptom}}');"});
                             {% endfor %}
                         {% endfor %}
                     {% endfor %}
                 {% endfor %}
            }else{
                 $('.resets_hidden').val('1');
                 $('#set_status').text('正在重置身体资料中......')
                 for(var i=0;i < syms.length;i++){
                    $('#symptom_td_'+syms[i]).attr({'onclick':"improve_click('"+ syms[i] + "')"});
                }
            }
            <!--for(var i=0;i < syms.length;i++){-->
                <!--if($('.improve_' + syms[i]).css('display')=='none'){-->
                    <!--$('.improve_' + syms[i]).css('display','');-->
                <!--}else{-->
                    <!--$('.improve_' + syms[i]).css('display','none');-->
                <!--}-->
            <!--}-->
        }
    }

    function improve_resets(){
        var resets_hidden = $('.resets_hidden').val();
        var improve_hidden = $('.improve_hidden').val();
        if(resets_hidden=='1'){
             alert('正在重置用户身体资料中~');
        }else{
            $('.symptom_td').attr({'onclick':''});   <!-- 清空所有td的点击事件 -->
            if(improve_hidden=='1'){
                $('#set_status').text('')
                $('.improve_hidden').val('0');
                {% for module_keys in perms_au %}
                    {% for symptom_keys in perms_au[module_keys]  %}
                        {% for symptom_key in symptom_keys  %}
                            {% for symptom in symptom_keys[symptom_key][0]  %}
                                 $('#symptom_td_{{symptom}}').attr({'onclick':"td_click('{{symptom}}');"});
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                {% endfor %}
            }else{
                $('.improve_hidden').val('1');
                $('#set_status').text('正在改善身体资料中......')
                for(var i=0;i < syms.length;i++){
                    $('#symptom_td_'+syms[i]).attr({'onclick':"td_click_resets('"+ syms[i] + "')"});
                }
            }
        }
    }


    function td_click_resets(sy){
        var s = "#selection_"+ sy;
        $(s).css({'background-color':''});
        $("#selection_input_"+sy).val('0');
        alert('该症状已改善');
        var sub =  contains(syms,sy)
        if(contains(syms,sy)>=0){
            syms.splice(sub,1);
        }
        if(contains(improve_syms,sy)<0){
           improve_syms.push(sy);
           }
        $('.improve_symptoms').val(improve_syms);

    }

    function improve_click(symptom){
        alert('已重置该症状');
        $(".improve_"+symptom).css('display','none');
        $("#selection_"+ symptom).css({'background-color':''});
        $("#selection_input_"+symptom).val('0');
        var sub =  contains(syms,symptom)
        if(contains(syms,symptom)>=0){
            syms.splice(sub,1);
        }
        $('.symptoms').val(syms);
    }


    function contains(arr, obj) {
        for (var i = 0; i < arr.length; i++) {
            if (arr[i] === obj) {
                return i
            }
        }
        return -1;
     }


function showdialog(page){
	
	var req = $.ajax({
		url: '{{ url_for('admin.user_dialogs',user_id=user.user_id) }}?page='+page,
		dataType: "json",
		cache: false,
		type: 'GET'
	});
	req.done(function (data) {
		var dialogs = data.result;
        if (!$.isEmptyObject(dialogs)) {
			var html = '<table class="table table-bordered table-condensed table-hover table-history"><thead><tr><th style="width:110px">时间</th><th style="width:60px">沟通方式</th><th>沟通情况</th><th>沟通属性</th><th>通话时长</th><th>沟通内容</th><th>录音编号</th><th style="width:60px">操作员</th></tr></thead><tbody>';
			for (var i in dialogs) {
				dialog = dialogs[i];
				if(dialog.connect_situation==1){ var con = '沟通'}else{var con = '未沟通'};
				if(dialog.communication_attr==1){ var com = '有效沟通'}else{var com = '无效沟通'};
				if(dialog.communicate_mode==1){ var mode = '电话'}
				else if(dialog.communicate_mode==2){var mode = 'TQ'}
				else if(dialog.communicate_mode==3){var mode = '微信'}
				else if(dialog.communicate_mode==4){var mode = 'QQ'}
				else{ var mode = '无'}
				html += '<tr><td>' + dialog.created + '</td><td>' + mode + '</td><td>' + con + '</td><td><pre>' + com + '</pre></td><td><pre>' + dialog.talk_time + '</pre></td><td>' + dialog.content + '</td><td>' + dialog.record_number + '</td><td>' + dialog.op_name + '</td></tr>';
			}
			html += '</tbody></table>';
			html += data.pages;
			$('#dialog_history').html(html);
			$('#dialog_nums').html(dialogs.length);
		}
		else {
			$('#dialog_history').html('无沟通记录');
			$('#dialog_nums').html(0);
		}
	});
}
$(function () {
	// var sel_perms = {% autoescape false %}{{ user.orgin if user else '[]' }}{% endautoescape %};

	// $.each(sel_perms,function(i){
	// 	$('input[id="'+sel_perms[i]+'"]').attr('checked',true);
	// });
	// $('#orgina').val('{{user.orgina}}');
	// $('#orginb').val('{{user.orginb}}');
	// $('#orginc').val('{{user.orginc}}');
	// $('#orgind').val('{{user.orgind}}');
	// $('#orgine').val('{{user.orgine}}');
	// $('#history').val('{{user.history}}');
	
	{% if current_user.team in ('A','A1','A2','B','B1','B2')  %}
    $('#dlb_type').select2({
        placeholder: '类型',
        width: '125px'
    });
    $('#dlb_valid').select2({
        placeholder: '是否有效',
        width: '135px'
    });
    $('#dlb_new').select2({
        placeholder: '是否新客户',
        width: '125px'
    });
    $('#dlb_connect').select2({
        placeholder: '是否接通',
        width: '135px'
    });
	$('#dlb_type').val('{{user.dlb_type}}').change();
	{% if user.dlb_valid  %}
	$('#dlb_valid').val('{{user.dlb_valid}}').change();
	{%endif %}
	{% if user.dlb_new  %}
	$('#dlb_new').val('{{user.dlb_new}}').change();
	{%endif %}
	{% if user.dlb_connect  %}
	$('#dlb_connect').val('{{user.dlb_connect}}').change();
	{%endif %}
	{%endif %}
	
	{%if user.origin in (19,27)%}
    $('#area').select2({
        placeholder: '区域',
        width: '125px'
    });
    $('#communication').select2({
        placeholder: '沟通情况',
        width: '135px'
    });
	$('#area').val('{{user.area}}').change();
	$('#communication').val('{{user.communication}}').change();
	{%endif %}
    $('#dialog_type').select2({
        width: '220px'
    });

    {% if current_user.team =='A2' or current_user.is_admin==1 %}
    new MMMS('m1', 'm2', 'm3');
    $('#medias select').select2({
        width: '200px'
    });
    {% endif %}

    $('#gender').select2({
        placeholder: '性别',
        width: '135px'
    });

    $('#expect_time').datetimepicker({
        language: 'zh-CN',
        format: 'yyyy-mm-dd hh:ii',
        minuteStep: 5,
        startDate: new Date(),
        todayBtn: true
    }).on('changeDate', function (ev) {
            });

    $('#origin').select2({
        placeholder: '客户来源',
        width: '95px'
    });
    $('#activity').select2({
        placeholder: '活动备注',
        width: '95px'
    });
    $('#product_intention').select2({
        placeholder: '产品意向',
        width: '175px'
    });
    $('#product_intention2').select2({
        placeholder: '产品意向2',
        width: '175px'
    });

    $('#assign_operator').select2({
        width: '130px',
        placeholder: '归属员工'
    });
    $('#assign_operator').select2("disable");

    <!--$('#profession').select2({-->
        <!--placeholder: '职业分类',-->
        <!--width: '300px'-->
    <!--});-->

//    $('#ages').select2({
//        placeholder: '客户年龄段',
//        width: '300px'
//    });
    {% if current_user.team=='B2' or current_user.is_admin==1 %}
    $('#tq_province').select2({
            width: '125px'
        });

    $('#tq_city').select2({
            width: '125px'
        });
    {% endif %}

    $('#talk_time').inputmask({
            mask:'99:99:99'
        });

    $('#address select').select2({
        width: '155px'
    });

    $('#dialog_type').select2({
        width: '220px'
    });

    $('.entry-select').select2({
        width: '80px'
    });

    $('#intent_level').select2({
        width: '130px'
    });

    $('#birthday').inputmask({
        mask: '9999-99-99'
    });

    {% if current_user.team=='B2' or current_user.is_admin==1 %}
        //验证省
        var tq_province = $('#tq_province').val();
        var tq_city = $('#tq_city').val();
            if (tq_province!='' || tq_city!=''){
                if(tq_province!='' && tq_province!=''){}else{
                    show_err('TQ进线地址不允许为空');
                    return false;
                }
            }
        new PCAS("tq_province", "tq_city");
        $('#tq_province').select2('val', '{{ user.tq_province }}').change();
        $('#tq_city').select2('val', '{{ user.tq_city }}').change();
    {% endif %}

    var selected_concerns = function () {
        var _ids = [];
        $('input[name="concern"]').filter(':checked').each(function () {
            _ids.push($(this).val());
        });
        return _ids;
    };
    {% if current_user.team in ('C1','C2','C') or current_user.is_admin==1 %}
        var selected_weixin = function () {
            var _ids = [];
            $('input[name="weixins"]').filter(':checked').each(function () {
                _ids.push($(this).val());
            });
            return _ids;
        };
    {% endif %}

    $('input.say').keypress(function (e) {
        if (e.which == 13) {
            var new_txt = $(this).val();
            if (new_txt == '') {
                if ($(this).attr('name') == 'yg') {
                    $('input[name=kh]').focus();
                }
                else {
                    $('input[name=yg]').focus();
                }
                return false;
            }
            var person = $(this).data('person');
            var _area = $('textarea[name=dialog_content]');
            var text = _area.val();
            if (text != '') {
                text += '\n';
            }
            text += person + '说：' + new_txt;
            _area.val(text);
            _area.scrollTop(_area[0].scrollHeight - _area.height());
            $(this).val(null);
            if ($(this).attr('name') == 'yg') {
                $('input[name=kh]').focus();
            }
            else {
                $('input[name=yg]').focus();
            }
            return false;
        }
    });

    function show_success(info) {
        $('#success').show();
        $('#success p').empty().html(info);
        $('html, body').animate({ scrollTop: 0 }, 'slow');
    };

    function show_err(err) {
        $('#error').show();
        $('#error p').empty().html(err);
        $('html, body').animate({ scrollTop: 0 }, 'slow');
    };

    /*   地址查询   */
    <!--new PCAS("province2", "city2", "district2");-->
    /*   地址查询   */
    new PCAS("province", "city", "district");
    $('#address select').change(function () {
        var _name = $(this).attr('name');
        if (_name == 'province') {
            $('#city').select2('val', '').change();
        }
        else if (_name == 'city') {
            $('#district').select2('val', '').change();
        }
        else {
            var _address = "";
            $.each(['#province', '#city', '#district'], function (index, name) {
                var d = $(name).val();
                if (d != "请选择" && d != "市辖县" && d != "市辖区") {
                    _address += $(name).val();
                }
            });
            $('#address .add-on').empty().text(_address);
        }
    });

    $('#reset_address').click(function () {
        $('#address-form').hide();
        $('#address_id').val(0);
        return false;
    });

    $('#add-address').click(function () {
        $('#ship_to').val(null);
        $('#province').val(null).change();
        $('#city').val(null).change();
        $('#district').val(null).change();
        $('#street1').val(null);
        $('#phone').val(null);
        $('#tel').val(null);
        $('#email').val(null);
        $('#postcode').val(null);
        $('#address_id').val(0);
        $('#save_address').text('增加收货地址');
        $('#address-form').show();
        $(window).scrollTop($('#address-form').offset().top);
        return false;
    });

    $('form#address-form').submit(function () {
        address.update(function (data) {
            if (data.result == true) {
                show_shipping_address();
                $('#address-form').hide();
            }
            else {
                bootbox.alert('地址更新失败:' + data.error);
            }
        });
        return false;
    });

	
    var Dialog = {
        update: function () {
            var req = $.ajax({
                url: '{{ url_for('admin.user_dialogs',user_id=user.user_id) }}',
                dataType: "json",
                cache: false,
                type: 'GET'
            });
            req.done(function (data) {
                var dialogs = data.result;
                if (!$.isEmptyObject(dialogs)) {
                    var html = '<table class="table table-bordered table-condensed table-hover table-history"><thead><tr><th style="width:110px">时间</th><th style="width:60px">沟通类型</th><th>沟通内容</th><th>解决方案</th><th>录音编号</th><th style="width:60px">操作员</th></tr></thead><tbody>';
                    for (var i in dialogs) {
                        dialog = dialogs[i];
                        html += '<tr><td>' + dialog.created + '</td><td>' + dialog.type_name + '</td><td><pre>' + dialog.content + '</pre></td><td><pre>' + dialog.solution + '</pre></td><td>' + dialog.record_number + '</td><td>' + dialog.op_name + '</td></tr>';
                    }
                    html += '</tbody></table>';
					html += data.pages;
                    $('#dialog_history').html(html);
                    $('#dialog_nums').html(data.length);
                }
                else {
                    $('#dialog_history').html(null);
                    $('#dialog_nums').html(0);
                }
            });
        },
        add: function () {
            var connect_situation = $('#connect_situation').val();
            var communicate_mode = $('#communicate_mode').val();
            var communication_attr =$('#communication_attr').val();
            var talk_time = $('#talk_time').val();
            var record_number = $('#record_number').val();
            var content = $('#dialog_content').val();
            if (content == '') {
                bootbox.alert('沟通内容不能为空！');
                return false;
            }
            if (communicate_mode == '') {
                bootbox.alert('请选择沟通方式！');
                return false;
            }
            if (connect_situation == '') {
                bootbox.alert('请选择接通情况！');
                return false;
            }
            if (communication_attr == '') {
                bootbox.alert('请选择沟通属性！');
                return false;
            }
            // if (talk_time == '') {
            //     bootbox.alert('请填写通话时长！');
            //     return false;
            // }
            var req = $.ajax({
                url: '{{ url_for('admin.add_dialog',user_id=user.user_id) }}',
                dataType: "json",
                type: 'POST',
                data: {communicate_mode:communicate_mode,connect_situation:connect_situation,communication_attr:communication_attr,content:content,record_number: record_number,talk_time:talk_time}
            });

            req.done(function (data) {
                if (data.result == true) {
                    showdialog(1);

                    $('#communicate_mode').val(null);
                    $('#connect_situation').val(null);
                    $('#communication_attr').val(null);
                    $('#record_number').val(null);
                    $('#talk_time').val(null);
                    $('#dialog_content').val(null);
                    show_success('沟通记录已保存！');
                }
                else {
                    bootbox.alert('添加沟通记录失败：' + data.error);
                }
            });
            req.fail(function (request, status, error) {
                bootbox.alert(error);
            });
            return false;
        }
    };
    showdialog(1);

    $('a#add_dialog').click(Dialog.add);

    $('#expect_over').click(function () {
        var req = $.ajax({
            url: '{{ url_for('admin.complete_user_expect',user_id=user.user_id) }}',
            dataType: "json",
            type: 'POST'
        });

        req.done(function (data) {
            if (data.result == true) {
                $('#user_expect').hide();
            }
            else {
                bootbox.alert('发生错误：' + data.error);
            }
        });
        req.fail(function (request, status, error) {
            bootbox.alert(error);
        });
        return false;
    });

    $('a#drop_user').click(function () {
        var confirm_text = '确认申请放弃该客户？';
        bootbox.prompt(confirm_text, function (result) {
            if(result === null){
				return;
			}else if(result == ''){
				bootbox.alert('原因为空,请填写原因!');
				return;
			}

            var req = $.ajax({
                url: '{{ url_for('admin.giveup_user',user_id=user.user_id) }}',
                dataType: "json",
                type: 'POST',
                data: {reason: result}
            });

            req.done(function (data) {
                if (data.result == true) {
                    window.location.href = "{{ url_for('admin.my_users') }}";
                }
                else {
                    bootbox.alert('发生错误：' + data.error);
                }
            });
            req.fail(function (request, status, error) {
                bootbox.alert(error);
            });
        });
        return false;
    });
    dmstatus = 1;
	$('a#dm_yx').click(function () {
		dmstatus = 1;
	});
	$('a#dm_wx').click(function () {
		dmstatus = 2;
	});
	$('a#dm_wfqr').click(function () {
		dmstatus = 3;
	});
	$('a#dm_yx,a#dm_wx,a#dm_wfqr').click(function () {
        var confirm_text = '确认该客户有效吗？确认后将无法更改!';
		if(dmstatus == 2){
			confirm_text = '确认该客户无效吗？确认后将无法更改!';
		}
		if(dmstatus == 3){
			confirm_text = '确认该客户无法确认吗？确认后将无法更改!';
		}
        bootbox.confirm(confirm_text, function (result) {
            if (result != true) {
                return;
            }
            var req = $.ajax({
                url: '{{ url_for('admin.dmyx') }}',
                dataType: "json",
                type: 'POST',
                data: {user_id: {{ user.user_id }},status:dmstatus}
            });

            req.done(function (data) {
                if (data.result == true) {
                    window.location.href = "{{ url_for('admin.my_users') }}";
                }
                else {
                    bootbox.alert('发生错误：' + data.error);
                }
            });
            req.fail(function (request, status, error) {
                bootbox.alert(error);
            });
        });
        return false;
    });


    $('a#sms_notify').click(function () {
        var _obj = $(this);
        var confirm_text = '<b>短信内容：</b><br/><p style="color:blue">'+_obj.data('message')+'</p>';
        bootbox.confirm(confirm_text, function (result) {
            if (result != true) {
                return;
            }

            var req = $.ajax({
                url: '{{ url_for('admin.user_sms_notify',user_id=user.user_id) }}',
                dataType: "json",
                type: 'POST'
            });

            req.done(function (data) {
                if (data.result == true) {
                    _obj.hide();
                }
                else {
                    bootbox.alert('发生错误：' + data.error);
                }
            });
            req.fail(function (request, status, error) {
                bootbox.alert(error);
            });
        });
        return false;
    });

    $('#user_id').val({{ user.user_id }});
    $('#name').val('{{ user.name }}');
    $('#user_type').val('{{config['OPEARTOR_ASSIGN_USER_TYPES'].get(user.assign_operator.assign_user_type)}}');
    $('#user_qq_number').val('{% if user.qq_number %}{{user.qq_number}}{% endif %}');
    $('#user_qq_number2').val('{% if user.qq_number2 %}{{user.qq_number2}}{% endif %}');
    $('#user_weixin_number').val('{% if user.weixin_number %}{{user.weixin_number}}{% endif %}');
    $('#user_weixin_number2').val('{% if user.weixin_number2 %}{{user.weixin_number2}}{% endif %}');
    $('#new_goods_need').val('{% if user.new_goods_need %}{{user.new_goods_need}}{% endif %}');
    $('#buy_more_time').val('{{row1[0][0]}}');
    $('#buy_more_money').val('{{row1[0][1]}}');
    <!--$('#disease').val('{{user.disease}}');-->

    $("input[type=radio][value='{{ user.tq_origin }}']").attr('checked','checked');
    $("input[type=radio][value='{{ user.tq_type }}']").attr('checked','checked');
    $("input[type=radio][value='{{ user.tq_user }}']").attr('checked','checked');
    {% if user.weixin %}{% for w in user.weixin %}$("input[type=checkbox][value='{{w}}']").attr('checked','checked');{% endfor %} {% endif %}


    $('#connect_situation').val({{user.connect_situation}});
    $('#communication_attr').val({{user.communication_attr}});
    $('#talk_time').val('{{user.talk_time}}');
    {% if not user.orgin_case %}
        {% if (user.orgina or user.orginb or user.orginc or user.orgind or user.orgine or user.history) %}
            var cases = '{{ user.orgina }}{{ user.orginb }}{{ user.orginc }}{{ user.orgind }}{{ user.orgine }}{{ user.history }}';
            $('#orgin_case').val(cases);
        {% else %}
            $('#orgin_case').val('');
        {% endif %}
    {% else %}
        $('#orgin_case').val("{{ user.orgin_case|safe}}".replace(/<br\/>/g,'\n') );
    {% endif %}


    $('#user_bianma').val({{user.user_id}});
    $('#origin').val({{ user.origin }}).change();
    $('#activity').val('{{ user.activity_status }}').change();
	{%if user.user_type == 6 %}//服务流转的时候不可修改来源
	$('#origin').select2("disable");//.select2("read");
	//$('#origin').attr("readonly",true);//.select2("read");
	//$("#origin:[readonly='readonly']").selectReadOnly();
	//$('#origin').attr("disabled", true);
	{%endif%}
	{%if user.product_intention3 %}
        $('#product_intention').val('{{ user.product_intention3 }}').change();
	{%endif%}
	{%if user.product_intention2 %}
        $('#product_intention2').val('{{ user.product_intention2 }}').change();
	{%endif%}
    $('#gender').val('{{ user.gender }}').change();
    $('#intent_level').val('{{ user.intent_level }}').change();
    $('#birthday').val('{{ user.birthday|default('',true) }}');
    $('#remark').val('{{ user.remark|default('',true) }}');
    $('#ages').val({{ user.ages }});
    $('#user_phone').val('{{ user.phone|default('',true) }}');
    $('#user_phone2').val('{{ user.phone2|default('',true) }}');
    $('#user_tel').val('{{ user.tel|default('',true) }}');
    $('#user_tel2').val('{{ user.tel2|default('',true) }}');
    {% if user.profession %}$('#profession').val('{{ user.profession|default('',true) }}').change();{% endif %}
    <!--$('#income').val({{ user.income }}).change();-->
    $('#expect_time').val('{{ user.expect_time|default('',true) }}');

    $('#m1').val('{{ user.m1|default('',true) }}').change();
    $('#m2').val('{{ user.m2|default('',true) }}').change();
    $('#m3').val('{{ user.m3|default('',true) }}').change();


    $('form#sms-form').submit(function(){
        var sms_message = $('#sms_message').val();
        if (sms_message==null || sms_message==''){
            alert('短信内容不允许为空');
            $('#sms_message').focus();
            return false;
        }

        if (sms_message.length>140){
            alert('短信内容不允许超过140个字');
            return false;
        }

        var req = $.ajax({
            url: '{{ url_for('admin.add_sms',user_id=user.user_id) }}',
            dataType: "json",
            type: 'POST',
            data: {message: sms_message}
        });

        req.done(function (data) {
            if (data.result == true) {
                $('#smsModal').modal('hide');
                bootbox.alert('短信已提交，请等待管理员审核！');
            }
            else {
                bootbox.alert('添加短信失败：' + data.error);
            }
        });
        req.fail(function (request, status, error) {
            bootbox.alert(error);
        });
        return false;
    });


    $('form#addyp-form').submit(function(){
        var bigcount = $('#bigcount').val();
        var mediumcount = $('#mediumcount').val();
        var smallcount = $('#smallcount').val();
        var qizaocount = $('#qizaocount').val();
        if (bigcount == 0 && mediumcount == 0 && smallcount == 0 && qizaocount == 0){
            alert('数量不能小于0');
            $('#bigcount').focus();
            return false;
        }

        var req = $.ajax({
            url: '{{ url_for('admin.add_dmyp',user_id=user.user_id) }}',
            dataType: "json",
            type: 'POST',
            data: {bigcount: bigcount,mediumcount:mediumcount,smallcount:smallcount,qizaocount:qizaocount}
        });

        req.done(function (data) {
            if (data.result == true) {
                $('#addypModal').modal('hide');
                bootbox.alert('添加成功！');
            }
            else {
                bootbox.alert('添加失败：' + data.error);
            }
        });
        req.fail(function (request, status, error) {
            bootbox.alert(error);
        });
        return false;
    });
    $('form#fwtjfg-form').submit(function(){
        var bigcount = $('#fgbigcount').val();
        var mediumcount = $('#fgmediumcount').val();
        var smallcount = $('#fgsmallcount').val();
        var qizaocount = $('#fgqizaocount').val();
        if (bigcount == 0 && mediumcount == 0 && smallcount == 0 && qizaocount == 0){
            alert('数量不能小于0');
            $('#bigcount').focus();
            return false;
        }

        var req = $.ajax({
            url: '{{ url_for('admin.user_fwtjfg',user_id=user.user_id) }}',
            dataType: "json",
            type: 'POST',
            data: {bigcount: bigcount,mediumcount:mediumcount,smallcount:smallcount,qizaocount:qizaocount}
        });

        req.done(function (data) {
            if (data.result == true) {
                $('#fwtjfgModal').modal('hide');
                bootbox.alert('添加成功！');
            }
            else {
                bootbox.alert('添加失败：' + data.error);
            }
        });
        req.fail(function (request, status, error) {
            bootbox.alert(error);
        });
        return false;
    });
    $('form#service-form').submit(function(){
        var isable_reason = $('#isable_reason').val();
		var servicetype = $('#servicetype').val();
        if (isable_reason == ''){
            alert('原因不能为空');
            $('#isable_reason').focus();
            return false;
        }

        var req = $.ajax({
            url: '{{ url_for('admin.user_servicetype',user_id=user.user_id) }}',
            dataType: "json",
            type: 'POST',
            data: {isable_reason: isable_reason,servicetype:servicetype}
        });

        req.done(function (data) {
            if (data.result == true) {
                $('#serviceModal').modal('hide');
                bootbox.alert('操作成功！');
            }
            else {
                bootbox.alert('操作失败：' + data.error);
            }
        });
        req.fail(function (request, status, error) {
            bootbox.alert(error);
        });
        return false;
    });
	
    $('form#khsldj-form').submit(function(){
        var qxhcode = $('#qxhcode').val().replace(/ /g,'').replace(/\n/g,',');
        var giftname = $('#giftname').val();
        var giftcount = $('#giftcount').val();
        var province = $('#province2').val();
        var city = $('#city2').val();
        var district = $('#district2').val();
        var pharmacyaddress = $('#pharmacyaddress').val();
        if (qxhcode == ''){
            alert('编码不能为空');
            $('#qxhcode').focus();
            return false;
        }

        var req = $.ajax({
            url: '{{ url_for('admin.khsldj',user_id=user.user_id) }}',
            dataType: "json",
            type: 'POST',
            data: {qxhcode: qxhcode,giftname:giftname,giftcount:giftcount,province:province,city:city,district:district,pharmacyaddress:pharmacyaddress}
        });

        req.done(function (data) {
            if (data.result == true) {
                $('#khsldjModal').modal('hide');
                bootbox.alert('添加成功！');
            }
            else {
                bootbox.alert('添加失败：' + data.error);
            }
        });
        req.fail(function (request, status, error) {
            bootbox.alert(error);
        });
        return false;
    });
	
    $('form#scratch-form').submit(function(){
        var qxhcode = $('#qxhcode2').val().replace(/ /g,'').replace(/\n/g,',');
        if (qxhcode == ''){
            alert('编码不能为空');
            $('#qxhcode2').focus();
            return false;
        }

        var req = $.ajax({
            url: '{{ url_for('admin.scratch',user_id=user.user_id) }}',
            dataType: "json",
            type: 'POST',
            data: {qxhcode: qxhcode}
        });

        req.done(function (data) {
            if (data.result == true) {
                $('#scratchModal').modal('hide');
                bootbox.alert('添加成功！');
            }
            else {
                bootbox.alert('添加失败：' + data.error);
            }
        });
        req.fail(function (request, status, error) {
            bootbox.alert(error);
        });
        return false;
    });


    $('form#jjyy-form').submit(function(){
        var jjyy = $('#jjyy').val()
		var jjyyid = $('#jjyyid').val()
        if (jjyy == ''){
            alert('原因不能为空');
            $('#jjyy').focus();
            return false;
        }

        var req = $.ajax({
            url: '{{ url_for('admin.khjjyy') }}',
            dataType: "json",
            type: 'POST',
            data: {id: jjyyid,reason:jjyy}
        });

        req.done(function (data) {
            if (data.result == true) {
                $('#jjyyModal').modal('hide');
                bootbox.alert('修改成功！');
            }
            else {
                bootbox.alert('修改失败：' + data.error);
            }
        });
        req.fail(function (request, status, error) {
            bootbox.alert(error);
        });
        return false;
    });
	
    function update_order_link(){
        var _href = '/order/add?user_id='+'{{ user.user_id }}'+'&phone='+$('#user_phone').val()+'&name='+$('#name').val();
        $('#order_link').attr('href',_href);
    }

    /*   提交表单   */
    $('form#user-form').submit(function () {
        var add_btn = $('button[type="submit"]');

        //保存身体资料数据
        $('.symptoms').val(syms);
        $('.improve_symptoms').val(improve_syms);

        //验证客户姓名
        var username = $('#name').val();
        if (username==null || username==''){
            show_err('客户姓名不允许为空');
            $('#name').focus();
            return false;
        }

        //验证客户来源
        var user_origin = $('#origin').val();
        if(user_origin==''||user_origin==null){
            show_err('请选择客户来源');
            $('#origin').focus();
            return false;
        }
		
		//验证产品意向
		var product_intention = $('#product_intention').val();
		if(product_intention==''||product_intention==null){
			show_err('请选择产品意向');
			$('#product_intention').focus();
			return false;
		}
	{%if user.origin in (19,27)%}
		//区域
		var area = $('#area').val();
		if(area==''||area==null){
			show_err('请选择区域');
			$('#area').focus();
			return false;
		}
		//沟通情况
		var communication = $('#communication').val();
		if(communication==''||communication==null){
			show_err('请选择沟通情况');
			$('#communication').focus();
			return false;
		}
		{%endif %}
		//验证性别
		var gender = $('#gender').val();
		if (gender==null || gender==''){
			show_err('性别不允许为空');
			$('#gender').focus();
			return false;
		}
		//验证客户年龄
		var ages = $('#ages').val();
		if (ages==null || ages=='NaN'){
			show_err('客户年龄不允许为空');
			$('#ages').focus();
			return false;
		}else{
			ages = parseInt(ages);
			if(parseInt(ages)!=ages){
				show_err('客户年龄填写不正确');
				$('#ages').focus();
				return false;
			}else if(ages>99 || ages<10){
				 show_err('客户年龄填写不正确');
				$('#ages').focus();
				return false;
			}
		}

        //电话，QQ,微信必填验证
        var phone = $('#user_phone').val();
        var phone2 = $('#user_phone2').val();
        var user_tel = $('#user_tel').val();
        var user_tel2 = $('#user_tel2').val();
        var qq_number = $('#user_qq_number').val();
        var qq_number2 = $('#user_qq_number2').val();
        var weixin_number = $('#user_weixin_number').val();
        var weixin_number2 = $('#user_weixin_number2').val();
        if((phone==null || phone=='')&&(phone2==null || phone2=='') && (user_tel==null || user_tel=='')&&(user_tel2==null || user_tel2=='')&&(qq_number==null || qq_number=='')&&(qq_number2==null || qq_number2=='')&&(weixin_number==null || weixin_number=='')&&(weixin_number2==null || weixin_number2=='')){
            show_err('电话，座机，QQ，微信，请必填其中一个。');
            $('#phone').focus();
            return false;
        }else{
            if(phone){
                //验证电话号码
                if(!validate_phone(phone)){
                    show_err('电话号码输入不正确。本地号码无需+区号028，手机号码首位不允许为0。');
                    $('#phone').focus();
                    return false;
                }
            }
        }

        var other_phones = ['#user_phone2','#user_tel','#user_tel2'];
        for (var i in other_phones ){
            var _phone = other_phones[i];
            var v = $(_phone).val();
            if (v!='' && !validate_phone(v)){
                show_err('电话号码输入不正确。本地号码无需+区号028，手机号码首位不允许为0。');
                $(_phone).focus();
                return false;
            }
        }

        add_btn.attr('disabled', true);
        //validate form
        var values = $('form').serializeArray();
		{%if user.user_type == 6 %}
		values.push({name: 'origin', value: user_origin});
		{%endif%}
        //values.push({name: 'entries', value: JSON.stringify(Entry.data())});
        values.push({name: 'concerns', value: JSON.stringify(selected_concerns())});
        {% if current_user.team in ('C1','C2','C') or current_user.is_admin==1 %}
            values.push({name: 'weixin', value: JSON.stringify(selected_weixin())});
        {% endif %}
		
		var perms = [];
            $('li input[type="checkbox"]:checked').each(function(){
			perms.push($(this).attr('id'));
		});
		values.push({name: 'orgin', value: JSON.stringify(perms)});
			
        var req = $.ajax({
            url: "{{ url_for('admin.edit_user',user_id=user.user_id) }}",
            dataType: 'json',
            type: 'POST',
            data: $.param(values)});

        req.done(function (data) {
            if (data.result == true) {
                show_success('保存资料成功！');
                update_order_link();
            }
            else {
                show_err(data.error);
            }
        });
        req.fail(function (request, status, err) {
            show_err('发生未知错误，请与管理员联系!');
        });
        req.always(function () {
            add_btn.attr('disabled', false);
        });
        return false;
    });

    $('#dialogCollapse').on('hidden',function(){
        $('.menubar').css('margin-bottom','40px');
    });

    $('#dialogCollapse').on('shown',function(){
        $('.menubar').css('margin-bottom','150px');
    });
	show('scratchdj');
});
function scratchdjqx(id){
	bootbox.confirm('确认取消吗,确认取消后将不能更改!', function (result) {
		if (result != true) {
			return;
		}
		var req = $.ajax({
			url: '{{ url_for('admin.scratchdjqx') }}',
			dataType: "json",
			type: 'POST',
			data: {id: id}
		});

		req.done(function (data) {
			if (data.result == true) {
				window.location.reload();
			}
			else {
				bootbox.alert('发生错误：' + data.error);
			}
		});
		req.fail(function (request, status, error) {
			bootbox.alert(error);
		});
	});
}
function khsldjqx(id){
	//bootbox.confirm('确认取消吗,确认取消后将不能更改!', function (result) {
//		if (result != true) {
//			return;
//		}
	var confirm_text = '确认取消吗,确认取消后将不能更改!';
	bootbox.prompt(confirm_text, function (result) {
		if(result === null){
			return;
		}else if(result == ''){
			bootbox.alert('原因为空,请填写原因!');
			return;
		}
		var req = $.ajax({
			url: '{{ url_for('admin.khsldjqx') }}',
			dataType: "json",
			type: 'POST',
			data: {id: id,reason:result}
		});

		req.done(function (data) {
			if (data.result == true) {
				window.location.reload();
			}
			else {
				bootbox.alert('发生错误：' + data.error);
			}
		});
		req.fail(function (request, status, error) {
			bootbox.alert(error);
		});
	});
}
function khsllq(id){
	bootbox.confirm('确认客户已经领取了礼物吗,确认后将不能更改!', function (result) {
		if (result != true) {
			return;
		}
		var req = $.ajax({
			url: '{{ url_for('admin.khsllq') }}',
			dataType: "json",
			type: 'POST',
			data: {id: id}
		});

		req.done(function (data) {
			if (data.result == true) {
				window.location.reload();
			}
			else {
				bootbox.alert('发生错误：' + data.error);
			}
		});
		req.fail(function (request, status, error) {
			bootbox.alert(error);
		});
	});
}
function khsljjlq(id){
	bootbox.confirm('确认客户拒接换购吗,确认后将不能更改!', function (result) {
		if (result != true) {
			return;
		}
		var req = $.ajax({
			url: '{{ url_for('admin.khsljjlq') }}',
			dataType: "json",
			type: 'POST',
			data: {id: id}
		});

		req.done(function (data) {
			if (data.result == true) {
				window.location.reload();
			}
			else {
				bootbox.alert('发生错误：' + data.error);
			}
		});
		req.fail(function (request, status, error) {
			bootbox.alert(error);
		});
	});
}

<!--$(function(){-->
    <!--if({{ user.intent_level_flag }}==1){-->
        <!--$('#myModal').modal();-->
    <!--}-->
<!--});-->

$(function(){
    var flag = 0
    {% if current_user.assign_user_type==1 %}
        {% for lv,val in config['NEW_USER_INTENT_LEVELS'].iteritems() %}
            if('{{ user.intent_level }}'=='{{ lv }}'){
                flag=1;
            }
        {% endfor %}
    {% endif %}
    {% if current_user.assign_user_type==2 %}
        {% for lv,val in config['VIP_USER_INTENT_LEVELS'].iteritems() %}
            if('{{ user.intent_level }}'=='{{ lv }}'){
                flag=1;
            }
        {% endfor %}
    {% endif %}

    {% if current_user.assign_user_type==5 %}
        {% for lv,val in config['SERVICE_USER_INTENT_LEVELS'].iteritems() %}
            if('{{ user.intent_level }}'=='{{ lv }}'){
                flag=1;
            }
        {% endfor %}
    {% endif %}
    if(flag==0){
         $('#myModal').modal();
    }
});
</script>
{{ place_auto_complete_js() }}
{%- endblock %}

{%- block main -%}
    <form name="sms-form" id="sms-form">
    <div id="smsModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-header">
            <a  class="close" data-dismiss="modal" aria-hidden="true">×</a>
            <blockquote style="color:#ccc">提示：短信需经后台审核后才可正常发送。</blockquote>
        </div>
        <div class="modal-body">
            <textarea class="span12" style="height: 90px" id="sms_message" name="sms_message" placeholder="短信内容"></textarea>
        </div>
        <div class="modal-footer" style="text-align: center">
            <button class="btn btn-success" type="submit">确认提交</button>
        </div>

    </div>
    </form>
    <form name="fwtjfg-form" id="fwtjfg-form">
    <div id="fwtjfgModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-header">
            <a  class="close" data-dismiss="modal" aria-hidden="true">×</a>
            <blockquote style="color:#ccc">提示：增加后不能修改,请确认后添加。</blockquote>
        </div>
        <div class="modal-body">
           大盒数量: <input type="text" style="width: 55px" placeholder="大盒数量" name="bigcount" id="fgbigcount" value="0">
			中盒数量:<input type="text" style="width: 55px" placeholder="中盒数量" name="mediumcount" id="fgmediumcount" value="0">
			小盒数量:<input type="text" style="width: 55px" placeholder="小盒数量" name="smallcount" id="fgsmallcount" value="0">
			芪枣数量:<input type="text" style="width: 55px" placeholder="芪枣数量" name="qizaocount" id="fgqizaocount" value="0">
        </div>
        <div class="modal-footer" style="text-align: center">
            <button class="btn btn-success" type="submit">确认提交</button>
        </div>

    </div>
    </form>
    <form name="addyp-form" id="addyp-form">
    <div id="addypModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-header">
            <a  class="close" data-dismiss="modal" aria-hidden="true">×</a>
            <blockquote style="color:#ccc">提示：增加后不能修改,请确认后添加。</blockquote>
        </div>
        <div class="modal-body">
           大盒数量: <input type="text" style="width: 55px" placeholder="大盒数量" name="bigcount" id="bigcount" value="0">
			中盒数量:<input type="text" style="width: 55px" placeholder="中盒数量" name="mediumcount" id="mediumcount" value="0">
			小盒数量:<input type="text" style="width: 55px" placeholder="小盒数量" name="smallcount" id="smallcount" value="0">
			芪枣数量:<input type="text" style="width: 55px" placeholder="芪枣数量" name="qizaocount" id="qizaocount" value="0">
        </div>
        <div class="modal-footer" style="text-align: center">
            <button class="btn btn-success" type="submit">确认提交</button>
        </div>

    </div>
    </form>
    <form name="service-form" id="service-form">
    <div id="serviceModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-header">
            <a  class="close" data-dismiss="modal" aria-hidden="true">×</a>
            <blockquote style="color:#ccc">提示：操作后不能修改。</blockquote>
        </div>
        <div class="modal-body"><input type="hidden" id="servicetype">
           原因: <input type="text" style="width: 255px" placeholder="原因" name="isable_reason" id="isable_reason" value="{{ user.isable_reason }}">
        </div>
        <div class="modal-footer" style="text-align: center">
            <button class="btn btn-success" type="submit">确认提交</button>
        </div>

    </div>
    </form>
    <form name="khsldj-form" id="khsldj-form">
    <div id="khsldjModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-header">
            <a  class="close" data-dismiss="modal" aria-hidden="true">×</a>
            <blockquote style="color:#ccc">提示：登记后不能修改,请确认后登记。</blockquote>
        </div>
        <div class="modal-body">
           空盒编码:<textarea id="qxhcode" name="qxhcode" style="width: 105px; height:50" placeholder="空盒编码"></textarea>
		   礼品名称: <select id="giftname" name="giftname" class="select2" style="width: 105px"><option value="气血和(小盒)">气血和(小盒)</option><option value="四件套">四件套</option>><option value="面膜">面膜</option></select>
		   礼品数量: <input type="text" style="width: 55px" placeholder="礼品数量" name="giftcount" id="giftcount">
		   <br>购买药房地址:
                                <select id="province2" name="province2" class="select2" style="width: 155px"></select>
                                <select id="city2" name="city2" class="select2" style="width: 170px"></select>
                                <select id="district2" name="district2" class="select2"
                                        style="width: 160px"></select> <input type="text" style="width: 265px" placeholder="药房地址" name="pharmacyaddress" id="pharmacyaddress">
        </div>
        <div class="modal-footer" style="text-align: center">
            <button class="btn btn-success" type="submit">确认提交</button>
        </div>

    </div>
    </form>

    <form name="scratch-form" id="scratch-form">
    <div id="scratchModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-header">
            <a  class="close" data-dismiss="modal" aria-hidden="true">×</a>
            <blockquote style="color:#ccc">提示：登记后不能修改,请确认后登记。</blockquote>
        </div>
        <div class="modal-body">
           刮刮卡编码:<textarea id="qxhcode2" name="qxhcode" style="width: 105px; height:50" placeholder="刮刮卡编码"></textarea>
        </div>
        <div class="modal-footer" style="text-align: center">
            <button class="btn btn-success" type="submit">确认提交</button>
        </div>

    </div>
    </form>
    
    <form name="jjyy-form" id="jjyy-form">
    <div id="jjyyModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-header">
            <a  class="close" data-dismiss="modal" aria-hidden="true">×</a>
            <blockquote style="color:#ccc">提示：请确认后提交。</blockquote>
        </div>
        <div class="modal-body"><input type="hidden" id="jjyyid" />
           未领取原因:<select id="jjyy" name="jjyy" class="select2" style="width: 170px">
           <option>刚提交还未确认</option>
           <option>未能联系客户无法确认</option>
           <option>没有业务员联系</option>
           <option>重新预约了时间</option>
           <option>想换四件套</option>
           <option>放弃领取</option>
           <option>已确认领取</option>
           </select>
        </div>
        <div class="modal-footer" style="text-align: center">
            <button class="btn btn-success" type="submit">确认提交</button>
        </div>

    </div>
    </form>
    <div class="alert alert-block alert-error fade in" id="error" style="display: none">
        <button type="button" class="close" onclick="$('#error').hide();">&times;</button>
        <p></p>
    </div>

    <div class="alert alert-block alert-success fade in" id="success" style="display: none">
        <button type="button" class="close" onclick="$('#success').hide();">&times;</button>
        <p></p>
    </div>

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                  <h4 class="modal-title" id="myModalLabel">流转数据提示</h4>
                </div>
                <div class="modal-body">
                    <label for="txt_departmentname">该用户为&nbsp;&nbsp;流转数据，请根据用户的意向等级做相应的修改</label>
                </div>
                <div class="modal-footer">
                  <button type="button" id="btn_submit" class="btn btn-primary" data-dismiss="modal"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>确认</button>
                </div>
            </div>
        </div>
    </div>

    <div class="accordion" id="accordion2" style="margin-bottom: 140px">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle" data-toggle="collapse" href="#collapseOne">
                <i class="icon-chevron-down"></i> 基本资料
            </a>
        </div>
        <form id="user-form" class="form-horizontal" method="post">
            <fieldset>
                <div id="collapseOne" class="accordion-body collapse in">
                    <div class="accordion-inner">

                        <div class="row-fluid" style="padding-bottom: 0">
                            <div class="span6">
                                <div class="control-group">
                                    <label class="control-label">客户编号</label>

                                    <div class="controls">
                                        <input id="user_bianma" name="user_bianma" placeholder="客户编号" type="text" style="width: 105px" readonly="">
                                    </div>
                                </div>

                                <div class="control-group">
                                    <label class="control-label">客户姓名</label>

                                    <div class="controls">
                                        <input id="name" name="name" placeholder="姓名" type="text"
                                               style="width: 55px">
                                        <input id="remark" name="remark" placeholder="备注" type="text"
                                               style="width: 125px;color: red">
                                    </div>
                                </div>


                                <div class="control-group">
                                    <label class="control-label">手机号码</label>

                                    <div class="controls">
                                        <input id="user_phone" name="user_phone" style="width: 140px" type="text"
                                               placeholder="手机号码1" value="{{ request.args.get('phone','') }}">
                                        <input id="user_phone2" name="user_phone2" style="width: 140px" type="text"
                                               placeholder="手机号码2">

                                    </div>
                                </div>

                                <div class="control-group">
                                    <label class="control-label">座机电话</label>

                                    <div class="controls">
                                        <input id="user_tel" name="user_tel" style="width: 140px" type="text"
                                               placeholder="座机号码1">
                                        <input id="user_tel2" name="user_tel2" style="width: 140px" type="text"
                                               placeholder="座机号码2">
                                    </div>
                                </div>

                                <div class="control-group">
                                    <label class="control-label">QQ号码</label>

                                    <div class="controls">
                                       <input id="user_qq_number" name="user_qq_number" placeholder="QQ号码" type="text" style="width: 140px;" onkeyup="this.value=this.value.replace(/\D/g,'')">
                                        <input id="user_qq_number2" name="user_qq_number2" placeholder="QQ号码2" type="text" style="width: 140px;" onkeyup="this.value=this.value.replace(/\D/g,'')">
                                    </div>
                                </div>

                                <div class="control-group">
                                    <label class="control-label">微信号码</label>

                                    <div class="controls">
                                       <input id="user_weixin_number" name="user_weixin_number" placeholder="微信号码" type="text" style="width: 140px;">
                                        <input id="user_weixin_number2" name="user_weixin_number2" placeholder="微信号码2" type="text" style="width: 140px;">
                                    </div>
                                </div>

                                {%if user.origin in (19,27)%}
                                <div class="control-group">
                                    <label class="control-label">区域</label>

                                    <div class="controls">
                                        <select name="area" id="area">
                                        <option></option>
                                        {%- for k,v in config['AREA'].iteritems() -%}
                                            <option value="{{ k }}">{{ v }}</option>
                                        {%- endfor -%}
                                        </select>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="span6">

                                <div class="control-group">
                                    <label class="control-label">归属员工</label>

                                    <div class="controls">
                                        <select name="assign_operator" id="assign_operator">
                                            {% if user %}
                                                {% if user.assign_operator_id %}
                                                    <option value="{{ user.assign_operator_id }}">{{ user.assign_operator.nickname }}</option>
                                                {% else %}
                                                    <option></option>
                                                {% endif %}
                                            {% else %}
                                                <option value="{{ current_user.id }}">{{ current_user.nickname }}</option>
                                            {% endif %}
                                        </select>
                                    </div>
                                </div>

                                <div class="control-group">
                                    <label class="control-label">性别</label>

                                    <div class="controls">
                                        <select id="gender" name="gender">
                                            <option></option>
                                            <option value="保密">保密</option>
                                            <option value="男">男</option>
                                            <option value="女">女</option>
                                        </select>
                                    </div>
                                </div>


                                <div class="control-group">
                                    <label class="control-label">职业</label>

                                    <div class="controls">
                                       <input id="profession" name="profession" placeholder="从事行业" type="text" style="width:120px;">
                                    </div>
                                </div>

                                <div class="control-group">
                                    <label class="control-label">年龄</label>

                                    <div class="controls">
                                        <input id="ages" name="ages" class="input-large" value="{{user.ages}}" type="text" style="width:55px;" />岁
                                    </div>
                                </div>

                                <div class="control-group">
                                    <label class="control-label">生日</label>

                                    <div class="controls">
                                        <input id="birthday" name="birthday" style="width: 145px" type="text"
                                                placeholder="1900-00-00">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label" style="background-color: #bce8f1">预约时间</label>

                                    <div class="controls">
                                        <input id="expect_time" name="expect_time" class="input-large" type="text"/>
                                    </div>
                                </div>
                                {%if user.origin in (19,27)%}
                                <div class="control-group">
                                    <label class="control-label">沟通情况</label>

                                    <div class="controls">
                                        <select name="communication" id="communication">
                                        <option></option>
                                        {%- for k,v in config['COMMUNICATIONS'].iteritems() -%}
                                            <option value="{{ k }}">{{ v }}</option>
                                        {%- endfor -%}
                                        </select>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle" data-toggle="collapse" href="#shujuziliao">
                <i class="icon-chevron-down"></i> 数据资料
            </a>
        </div>
        <div id="shujuziliao" class="accordion-body collapse in">
            <div class="accordion-inner">
                <div class="row-fluid" style="padding-bottom: 0">
                    <div class="row-fluid">
                        <div class="span6">
                            <div class="control-group">
                                <label class="control-label">客户类型</label>
                                <div class="controls">
                                   <input id="user_type" name="user_type" placeholder="客户类型" type="text" readonly="" style="width:110px">
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">客户来源</label>
                                <div class="controls">
                                    <select id="origin" name="origin" class="space">
                                        <option></option>
                                        {%- for k,v in config['USER_ORIGINS'].iteritems() -%}
                                            <option value="{{ k }}">{{ v }}</option>
                                        {%- endfor -%}
                                    </select>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">意向等级</label>
                                <div class="controls">
                                    <select id="intent_level" name="intent_level" class="space">
                                        <option></option>
                                            {% if current_user.assign_user_type==1 %}
                                                {% for k in config['NEW_USER_INTENT_LEVELS_SORT'] %}
                                                    <option value="{{ k }}">{{ config['NEW_USER_INTENT_LEVELS'][k] }}</option>
                                                {% endfor %}
                                            {% endif %}
                                            {% if current_user.assign_user_type==2 %}
                                                {% for k in config['VIP_USER_INTENT_LEVELS_SORT'] %}
                                                    <option value="{{ k }}">{{ config['VIP_USER_INTENT_LEVELS'][k] }}</option>
                                                {% endfor %}
                                            {% endif %}
                                            {% if current_user.assign_user_type==5 %}
                                                {% for k in config['SERVICE_USER_INTENT_LEVELS_SORT'] %}
                                                    <option value="{{ k }}">{{ config['SERVICE_USER_INTENT_LEVELS'][k] }}</option>
                                                {% endfor %}
                                            {% endif %}
                                    </select>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">活动备注</label>
                                <div class="controls">
                                    <select id="activity" name="activity" class="space">
                                        <option></option>
                                        {%- for k,v in config['ACTIVITY_STATUS'].iteritems() -%}
                                            <option value="{{ k }}">{{ v }}</option>
                                        {%- endfor -%}
                                    </select>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">产品活动意向</label>
                                <div class="controls">
                                    <select id="product_intention" name="product_intention3" class="space" style="width: 285px">
                                        {%- for item in items -%}
                                            <option value="{{ item.id }}" price="{{ item.price }}" integration="{{ item.integration }}" sku-id="{{ item.sku_id }}" unit="{{ item.unit }}" type="{{ item.type }}"{% if item.type==2 %} class="sku_set_style"{% endif %}>{{ item.name }}</option>
                                        {%- endfor -%}
                                    </select>
                                    <select id="product_intention2" name="product_intention2" class="space" style="width: 285px">
                                        {%- for item in items -%}
                                            <option value="{{ item.id }}" price="{{ item.price }}" integration="{{ item.integration }}" sku-id="{{ item.sku_id }}" unit="{{ item.unit }}" type="{{ item.type }}"{% if item.type==2 %} class="sku_set_style"{% endif %}>{{ item.name }}</option>
                                        {%- endfor -%}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="span6">
                            <div class="control-group">
                                <label class="control-label">复购次数</label>
                                <div class="controls">
                                   <input id="buy_more_time" name="buy_more_time" placeholder="复购次数" type="text" readonly="">
                                </div>
                            </div>

                             <div class="control-group">
                                <label class="control-label">复购金额</label>
                                <div class="controls">
                                   <input id="buy_more_money" name="buy_more_money" placeholder="复购金额" type="text" readonly="">
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">新品需求</label>
                                <div class="controls">
                                   <input id="new_goods_need" name="new_goods_need" placeholder="新品需求" type="text">
                                </div>
                            <hr/>
                            </div>
                        </div>
                    </div>
                    <div class="row-fluid">
                        <div class="span12">
                            {% if current_user.team=='B2' or current_user.is_admin==1 %}
                            <div class="control-group">
                                <label class="control-label">TQ进线选择</label>

                                <div class="controls">
                                    来源:
                                        {% for k,v in config['TQ_ORIGIN'].iteritems() %}
                                            <label class="inline radio"><input type="radio" name="tq_origin" value="{{ k }}"/>{{ v }}</label>
                                        {% endfor %}
                                            <input type="radio" style="display:none;" name="tq_origin" checked="checked" value="0" />
                                    &nbsp;&nbsp;&nbsp;&nbsp;
                                    类型:
                                        {% for k,v in config['TQ_TYPE'].iteritems() %}
                                            <label class="inline radio"><input type="radio" name="tq_type" value="{{ k }}"/>{{ v }}</label>
                                        {% endfor %}
                                            <input type="radio" style="display:none;" name="tq_type" checked="checked" value="0" />
                                    &nbsp;&nbsp;&nbsp;&nbsp;
                                    客户：
                                    {% for k,v in config['TQ_USER'].iteritems() %}
                                        <label class='inline radio'><input type="radio" name="tq_user" value="{{ k }}"/>{{ v }}</label>
                                    {% endfor %}
                                    <input type="radio" style="display:none;" name="tq_user" checked="checked" value="0" />
                                    省市：
                                    <select id="tq_province" name="tq_province" style="width: 135px"></select>
                                    <select id="tq_city" name="tq_city" style="width: 150px"></select>
                                </div>
                            </div>
                            {% endif %}
                            {% if current_user.team in ('C1','C2','C') or current_user.is_admin==1 %}
                            <div class="control-group">
                                <label class="control-label">微信情况</label>

                                <div class="controls">
                                    {% for k,v in config['WEIXINS'].iteritems() %}
                                    <label class="inline checkbox"><input type="checkbox" name="weixins"
                                                                          value="{{ k }}"/>{{ v }}</label>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            {% if current_user.team =='A2' or current_user.is_admin==1 %}
                            <div class="control-group">
                                <label class="control-label" style="background-color: #fdf59a">媒体来源</label>

                                <div class="controls" id="medias">
                                    <select id="m1" name="m1" style="width: 200px"></select>
                                    <select id="m2" name="m2" style="width: 200px"></select>
                                    <select id="m3" name="m3" style="width: 200px"></select>
                                </div>
                            </div>
                            {% endif %}
                            {% if current_user.team =='C3' or current_user.is_admin==1 %}
                            <div class="control-group">
                                <label class="control-label">新老客户</label>

                                <div class="controls">
                                    <label style="float:left; padding-right:15px;"><input name="is_new" value="0" type="radio">老客户</label><label><input
                                        name="is_new" value="1" type="radio" checked="checked">新客户</label><br/>
                                    <!--<label>复购次数:<input id="fugou" name="fugou" class="input-large" type="text"/>新客户为0，可不填写</label>-->
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">病症</label>

                                <div class="controls">
                                    <textarea name="disease" style="width:600px; height:80px;" class="input" id="disease">{{user.disease}}</textarea>
                                </div>
                            </div>
                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle" data-toggle="collapse" href="#collapseTwo2">
                <i class="icon-chevron-down"></i> 身体资料
            </a>
        </div>
        <div id="collapseTwo2" class="control-group collapse in">
            <div class="controls" style="border:1px solid #bec3c7; margin-left:10px;">
                <button type="button" class="btn btn-primary mystyle_btn" data-toggle="button" onclick="resets();">错选更正</button>
                <button type="button" class="btn btn-primary mystyle_btn" data-toggle="button" onclick="improve_resets();">症状改善</button>
                <p align="center" id="set_status" style="color:#ff0000;"></p>
                <p>设置：</p>
                <hr/>
                <input type="hidden" class="resets_hidden" value="0"/>
                <input type="hidden" class="improve_hidden" value="0"/>
                <input type="hidden" class="symptoms" value="" name="symptoms"/>
                <input type="hidden" class="improve_symptoms" value="" name="improve_symptoms"/>
                {% for module_keys in perms_au %}
                    <table class="table" data-toggle="table" style="width:46%;height:200px;float:left; margin-left:10px;">
                        <p style="float:left; font-size:18px; font-weight:bold;">{{ config['USER_ORGIN'][module_keys] }}</p>
                        {% for symptom_keys in perms_au[module_keys]  %}
                            {% for symptom_key in symptom_keys  %}
                            <tr>
                                <td style="width:90px; text-align:center; float:left;border:1px solid #bec3c7;font-weight:bold;">{{ config['USER_ORGIN_TYPE'][symptom_key] }}：</td>
                                {% for symptom in symptom_keys[symptom_key][0]  %}
                                    <td id="symptom_td_{{symptom}}" class="symptom_td"  onclick="td_click('{{symptom}}');">
                                        <div class="selection" id="selection_{{symptom}}"><input type="hidden" value="0" id="selection_input_{{symptom}}" class="selection_input"/></div>
                                        {{ config['USER_ORGIN_TYPE_DETAIL'][symptom] }}
                                        <div class="improve_{{symptom}}" id="improve" style="display:none;"></div>
                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        {% endfor %}
                    </table>
                {% endfor %}
                <div style="clear:both;"></div>
                <p style="font-size:18px; font-weight:bold;">病史：</p>
                <textarea id="orgin_case" name="orgin_case" type="text" style="width:1000px;height:100px;border:1px solid #bec3c7;float:left;" class="input" placeholder="病史" ></textarea>
            </div>
        </div>
    </div>

    <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" href="#introducer">
                    <i class="icon-chevron-down"></i> 转介绍登记
                </a>
            </div>
            <div id="introducer" class="accordion-body collapse in">
                <div class="accordion-inner">
                    <div class="row-fluid" style="padding-bottom: 0" id="" >
                        <!--<p style="font-size:18px;font-weight:bold;">转介绍</p>-->
                    </div>
                </div>
                <div class="control-group span3">
                    <label class="control-group">介绍人归属：</label>
                    <table class="table table-bordered">
                        <thead>
                            <th >日期</th>
                            <th>ID</th>
                            <th>姓名</th>
                        </thead>
                        <tbody>
                            {% if row2 %}
                                {% for  row in row2 %}
                                    <tr>
                                        <td>{{ row[0] }}</td>
                                        <td>{{ row[1] }}</td>
                                        <td>{{ row[2] }}</td>
                                    </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="control-group span3">
                    <label class="control-group">转介绍人总计：</label>
                    <table class="table table-bordered">
                        <tr>
                            <td style="width:40px;">人数:</td>
                            <td>{% if row3 %} {{row3[0][0]}} {% endif %}</td>
                            <td style="width:40px;">金额:</td>
                            <td>{% if row4 %} {% if row4[0][0] %}{{ row4[0][0] }}{% endif %} {% endif %}</td>
                        </tr>
                    </table>
                </div>
                <div class="control-group span6">
                    <label class="control-group">明细：</label>
                    <table class="table table-bordered">
                        <thead>
                            <th >日期</th>
                            <th>ID</th>
                            <th>姓名</th>
                            <th>累计订购金额</th>
                            <th>累计订单数</th>
                        </thead>
                        <tbody>
                            {% if row5 %}
                                {% for row in row5 %}
                                    {% if row[3] == 0 %}
                                         <tr>
                                            <td>{{row[0]}}</td>
                                            <td>{{row[1]}}</td>
                                            <td>{{row[2]}}</td>
                                            <td></td>
                                            <td></td>
                                         </tr>
                                    {% else %}
                                        <tr>
                                            <td>{{row[0]}}</td>
                                            <td>{{row[1]}}</td>
                                            <td>{{row[2]}}</td>
                                            {% if row[3]==None %}
                                                <td></td>
                                                <td></td>
                                            {%  else %}
                                                <td>{{row[3]}}</td>
                                                <td>{{row[4]}}</td>
                                            {% endif%}
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    <div class="navbar navbar-fixed-bottom menubar">
        <div class="container-fluid">
            {% if user.qxhdm_user_id and (user.is_valid < 1 or user.is_valid == 3) %}
                <a href="#" id="dm_yx" class="btn btn-primary btn-small">有效</a>
                <a href="#" id="dm_wx" class="btn btn-danger btn-small">无效</a>
                <a href="#" id="dm_wfqr" class="btn btn-danger btn-small">无法确认</a>
            {% endif %}
			<a href="#" id="khsldj" class="btn btn-primary btn-small" onclick="$('#khsldjModal').modal('show');">空盒送礼登记</a>
			{% if current_user.assign_user_type == 5 %}
                <a href="#" id="scratch" class="btn btn-primary btn-small" onclick="$('#scratchModal').modal('show');">刮刮卡</a>
                <a href="#" id="fwtjfg" class="btn btn-primary btn-small" onclick="$('#fwtjfgModal').modal('show');">推荐复购</a>
                <a href="#" id="dm_addyp" class="btn btn-primary btn-small" onclick="$('#addypModal').modal('show');">复购预判</a>
            {% endif %}
            {% if user.qxhdm_user_id or user.origin==19 %}
				{% if user.is_isable %}
				<a href="#" id="service_qy" class="btn btn-primary btn-small" onclick="$('#servicetype').val(0);$('#serviceModal').modal('show');">启用</a>
				{% else %}
				<a href="#" id="service_ty" class="btn btn-danger btn-small" onclick="$('#servicetype').val(1);$('#serviceModal').modal('show');">停用</a>
				{% endif %}
            {% endif %}
            <button type="submit" class="btn btn-success btn-small">保存资料</button>
            <a href="{{ url_for('admin.add_order',phone=user.phone,name=user.name,user_id=user.user_id) }}" class="btn btn-primary btn-small" id="order_link">创建订单</a>
            <a href="javascript:;"  class="btn btn-primary btn-small" id="data_markup">市场数据标记</a>
            {% if user.assign_operator_id == current_user.id %}
                {% set mobile_phones = user.mobile_phones %}
                {% if user.user_type==2 and not user.is_sms and mobile_phones %}
                    <a href="#" id="sms_notify" class="btn btn-warning btn-small" data-message="{{ user.sms_message }}">短信提醒</a>
                {% endif %}
                <!--{% if mobile_phones %}-->
                    <!--<a href="#" id="send_sms" class="btn btn-warning btn-small" onclick="$('#smsModal').modal('show');">发送短信</a>-->
                <!--{% endif %}-->
                <a href="#" id="drop_user" class="btn btn-danger btn-small">申请放弃客户</a>
            {% endif %}
            </div>
    </div>


    </fieldset>
    </form>
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle" data-toggle="collapse" href="#dialogModule">
                <i class="icon-chevron-down"></i> 沟通记录 (<span id="dialog_nums"></span>)
            </a>
        </div>
        <div id="dialogModule" class="accordion-body collapse in">
            <div class="accordion-inner">
                <div class="row-fluid" style="padding-bottom: 0" id="dialog_history">
                    <img src="{{ url_for('static',filename="img/ajax-loader.gif") }}" border="0"/> 正在费力加载中...
                </div>

            </div>
        </div>
    </div>

    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle" data-toggle="collapse" href="#orderInformation">
                <i class="icon-chevron-down"></i>订单信息
            </a>
        </div>
        <div id="orderInformation" class="accordion-body collapse" style="margin-left:50px;">
            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" href="#addressModule" onclick="show('shdz');">
                        <i class="icon-chevron-down"></i> 收货地址
                    </a>
                </div>
                <div id="addressModule" class="accordion-body collapse">
                    <div class="accordion-inner">
                        <div id="shipping_address"><img src="{{ url_for('static',filename="img/ajax-loader.gif") }}"
                                                        border="0"/>正在费力加载中...
                        </div>
                            <a href="#" id="add-address"><i class="icon-plus"></i> 增加收货地址</a>
                        <hr/>
                        <form action="" id="address-form" class="form-horizontal dl-horizontal" style="display: none">
                            <input id="address_id" name="address_id" type="hidden" value="0">
                            <input id="user_id" name="user_id" type="hidden" value="{{ user.user_id }}">

                            <div class="control-group">
                                <label class="control-label" for="ship_to">收货人姓名</label>

                                <div class="controls">
                                    <input type="text" id="ship_to" name="ship_to" class="input input-large"
                                           required='请输入用户姓名'/>
                                </div>
                            </div>


                            <div class="control-group">
                                <label class="control-label" for="street1">地 址</label>

                                <div class="controls">
                                    <div id="address">
                                        <select id="province" name="province" class="select2" style="width: 155px"></select>
                                        <select id="city" name="city" class="select2" style="width: 170px"></select>
                                        <select id="district" name="district" class="select2"
                                                style="width: 160px"></select><br/>

                                        <div class="input-prepend" style="margin-top: 10px">
                                            <span class="add-on"></span>
                                            <input type="text" id="street1" name="street1" class="input input-large"
                                                   style="width: 300px" placeholder="街道地址" required/>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label" for="phone">联系电话</label>

                                <div class="controls">
                                    <input type="text" id="phone" name="phone" placeholder="手机号码" required/>
                                    <input type="text" id="tel" name="tel" placeholder="固定电话" style="margin-left: 10px"/>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label" for="email">邮箱地址</label>

                                <div class="controls">
                                    <input type="text" id="email" name="email" class="input"/>

                                </div>
                            </div>
                            <div class="control-group">
                                <label class="control-label" for="postcode">邮政编码</label>

                                <div class="controls">
                                    <input type="text" id="postcode" name="postcode" class="input input-small"
                                           placeholder="邮政编码"/>

                                </div>
                            </div>
                            <div id="update_address" style="margin-left: 130px">
                                <button type="submit" class="btn btn-success" id="save_address">保存地址</button>
                                <a href="#" id="reset_address" class="btn">取消</a><span style="margin-left: 20px"></span>
                            </div>
                        <!--</form>-->
                    </div>
                </div>
            </div>

            <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle" data-toggle="collapse" href="#integrationModule" onclick="show('integration');">
                <i class="icon-chevron-down"></i> 用户积分 (<span style="color:red">{{user.integration}}</span>)
            </a>
        </div>
        <div id="integrationModule" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="row-fluid">
                    <div class="span10" id="integration_history">
                        <img src="{{ url_for('static',filename="img/ajax-loader.gif") }}" border="0"/>正在费力加载中...
                    </div>
                </div>
            </div>
        </div>
    </div>

            <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle" data-toggle="collapse" href="#orderModule" onclick="show('lsgmjl');">
                <i class="icon-chevron-down"></i> 历史购买记录 (<span id="order_nums" style="color:red">{{ordercount}}</span>)
            </a>
        </div>
        <div id="orderModule" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="row-fluid">
                    <div class="span7" id="order_history">
                        <img src="{{ url_for('static',filename="img/ajax-loader.gif") }}" border="0"/>正在费力加载中...
                    </div>
                    <div class="span5" id="order_item_history"></div>
                </div>
            </div>
        </div>
    </div>


            <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle" data-toggle="collapse" href="#voucherModule" onclick="show('voucher');">
                <i class="icon-chevron-down"></i> 代金券　(<span id="voucher_nums"></span>)
            </a>
        </div>
        <div id="voucherModule" class="accordion-body collapse">
            <div class="accordion-inner">
                <div id="voucher_history"><img src="{{ url_for('static',filename="img/ajax-loader.gif") }}"
                                           border="0"/>正在费力加载中...
                </div>
            </div>

        </div>
    </div>

        </div>

    </div>

    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle" data-toggle="collapse" href="#serviceDate">
                <i class="icon-chevron-down"></i>服务组数据
            </a>
        </div>
        <div id="serviceDate" class="accordion-body collapse" style="margin-left:50px;">
            <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" href="#orderyfModule" onclick="show('orderyf');">
                    <i class="icon-chevron-down"></i> 药房复购预判　(<span id="orderyf_nums" style="color:red">{{orderyfcount}}</span>)
                </a>
            </div>
            <div id="orderyfModule" class="accordion-body collapse">
                <div class="accordion-inner">
                    <div id="orderyf_history"><img src="{{ url_for('static',filename="img/ajax-loader.gif") }}"
                                               border="0"/>正在费力加载中...
                    </div>
                </div>

            </div>
        </div>

            <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" href="#khsldjModule" onclick="show('khsldj');">
                    <i class="icon-chevron-down"></i> 空盒送礼登记　(<span id="khsldj_nums" style="color:red">{{khsldjcount}}</span>)
                </a>
            </div>
            <div id="khsldjModule" class="accordion-body collapse">
                <div class="accordion-inner">
                    <div id="khsldj_list"><img src="{{ url_for('static',filename="img/ajax-loader.gif") }}"
                                               border="0"/>正在费力加载中...
                    </div>
                </div>

            </div>
        </div>

            <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" href="#scratchdjModule" onclick="show('scratchdj');">
                    <i class="icon-chevron-down"></i> 刮刮卡登记　(<span id="scratchdj_nums" style="color:red">{{scratchdjcount}}</span>)
                </a>
            </div>
            <div id="scratchdjModule" class="accordion-body collapse">
                <div class="accordion-inner">
                    <div id="scratchdj_list"><img src="{{ url_for('static',filename="img/ajax-loader.gif") }}"
                                               border="0"/>正在费力加载中...
                    </div>
                </div>

            </div>
        </div>

            <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" href="#fwtjfgModule" onclick="show('fwtjfg');">
                    <i class="icon-chevron-down"></i> 推荐复购　(<span id="fwtjfg_nums"></span>)
                </a>
            </div>
            <div id="fwtjfgModule" class="accordion-body collapse">
                <div class="accordion-inner">
                    <div id="fwtjfg_list"><img src="{{ url_for('static',filename="img/ajax-loader.gif") }}"
                                               border="0"/>正在费力加载中...
                    </div>
                </div>

            </div>
        </div>

         </div>
     </div>

</div>

{%- endblock -%}

{% block ext_content %}
    <div class="accordion-group  navbar navbar-fixed-bottom" id="dialogCollapse">
        <div class="accordion-heading" style="background-color:#e0f2be">
            <a class="accordion-toggle" data-toggle="collapse" href="#addDialogModule">
                <i class="icon-chevron-down"></i> 增加沟通记录
            </a>
        </div>
        <div id="addDialogModule" class="accordion-body collapse in">
            <div class="accordion-inner">
                <div class="row-fluid">
                    <div class="span3" style="text-align: left;font-size:20px;">
                        <p>拨打记录:</p>
                    </div>
                    <div class="span3" style="text-align: left;font-size:20px;">
                        <p></p>
                    </div>
                    <div class="span6" style="text-align: left; font-size:20px;">
                        <p>沟通记录:</p>
                    </div>
                </div>
                <div class="row-fluid">
                    <div class="span3" style="text-align: left">
                        <div class="input-prepend space" style="margin-bottom:6px;">
                            <span class="add-on">沟通方式：</span>
                            <select id="communicate_mode" name="communicate_mode" class="space">
                                <option value=""></option>
                                {% for va,vl in config['COMMUNICATE_MODE'].iteritems() %}
                                    <option value="{{ va }}">{{ vl }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="input-prepend space" style="margin-bottom:6px;">
                            <span class="add-on">沟通情况：</span>
                            <select id="connect_situation" name="connect_situation" class="space">
                                <option value=""></option>
                                <option value="1">沟通</option>
                                <option value="2">未沟通</option>
                            </select>
                        </div>
                        <div class="input-prepend space">
                            <span class="add-on">沟通属性：</span>
                             <select id="communication_attr" name="communication_attr" class="space">
                                 <option value=""></option>
                                <option value="1">有效沟通</option>
                                <option value="2">无效沟通</option>
                             </select>
                        </div>
                    </div>
                    <div class="span3" style="text-align: left">
                         <div class="input-prepend space"  style="margin-bottom:0px;">
                            <span class="add-on">通话时长：</span>
                            <input name="talk_time" id="talk_time" type="text" data-person="通话时长" style="width:200px;" placeholder="00:00:00">
                         </div>
                         <div class="input-prepend space"  style="margin-top:6px;">
                            <span class="add-on">录音编号：</span>
                            <input name="record_number" id="record_number" type="text" data-person="录音编号" style="width:200px;">
                         </div>
                    </div>
                    <div class="span6" style="text-align: ;left">
                        <textarea name="dialog_content" id="dialog_content"
                                  style="width:265px;height:90px;background-color:#f5f3ef;overflow-y: auto"
                                  placeholder="沟通内容"></textarea>
                        <a href="#" class="btn btn-success btn-mini" id="add_dialog">添加沟通记录</a>
                        <!--<button type="submit" class="btn btn-primary">保存客户</button>-->
                    </div>
                     </form>
                </div>
            </div>
            </div>
    </div>
<script>
var show_shipping_address = function () {
	var req = $.ajax({
		url: '{{ url_for('admin.user_address_api',user_id=user.user_id) }}',
		dataType: "json",
		cache: false,
		type: 'GET'
	});
	req.done(function (data) {
		var addresses = data.addresses;
		if (!$.isEmptyObject(addresses)) {
			var html = '<table class="table table-bordered table-condensed table-history"><thead><tr><th>收货人</th><th>手机号</th><th>电话</th><th>收货地址</th><th>邮编</th><th></th></tr></thead><tbody>';
			$.each(addresses, function () {

				var attrs = '';
				$.each(this, function (i, item) {
					attrs += i + '="' + item + '" ';
				});
				tip_info = '<a href="#" class="edit_address" ' + attrs + '><i class="icon-edit"></i></a>';
				html += '<tr><td>' + this.ship_to + '</td><td>' + this.phone + '</td><td>' + this.tel + '</td><td>' + this.format_address + '</td><td>' + this.postcode + '</td><td style="text-align:center">' + tip_info + '</td></tr>';
			});

			html += '</tbody></table>';
			$('#shipping_address').html(html);

			$('a.edit_address').click(function () {
				var addr = $(this);
				$('#address_id').val(addr.attr('id'));
				$.each(['ship_to', 'street1', 'postcode', 'phone', 'tel', 'email'], function (k, i) {
					$('#' + i).val(addr.attr(i));
				});

				$.each(['province', 'city', 'district'], function (k, i) {
					$('#' + i).val(addr.attr(i)).change();
				});
				$('#address-form').show();
				$('#save_address').text('更新地址');
				$(window).scrollTop($('#address-form').offset().top);
				return false;
			});
		}
		else {
			$('#shipping_address').html('');
		}
	});
};
//show_shipping_address();

var show_integration = function () {
	var req = $.ajax({
		url: '{{ url_for('admin.user_integration',user_id=user.user_id) }}',
		dataType: "json",
		cache: false,
		type: 'GET'
	});
	req.done(function (data) {
		var sms_list = data.result;
		if (!$.isEmptyObject(sms_list)) {
			var html = '<table class="table table-bordered table-condensed table-hover table-history"><thead><tr><th>积分</th><th>类型</th><th>备注</th><th>操作人</th><th>时间</th></tr></thead><tbody>';
			for (var i in sms_list) {
				sms = sms_list[i];
				html += '<tr><td>' + sms.integration + '</td><td>' + sms.type + '</td><td>' + sms.mero + '</td><td>' + sms.operator + '</td><td>' + sms.created + '</td></tr>';
			}
			html += '</tbody></table>';
			$('#integration_history').html(html);
		}
		else {
			$('#integration_history').html('无积分记录');
		}
	});
};

var show_orders = function () {
	var req = $.ajax({
		url: '{{ url_for('admin.user_orders',user_id=user.user_id) }}',
		dataType: "json",
		cache: false,
		type: 'GET'
	});
	req.done(function (data) {
		var orders = data.orders;
		if (!$.isEmptyObject(orders)) {
			var html = '<table class="table table-bordered table-condensed table-hover table-history"><thead><tr><th>订单编号</th><th>付款方式</th><th>金额</th><th>状态</th><th>员工</th><th>下单时间</th><th></th></tr></thead><tbody>';
			for (var i in orders) {
				order = orders[i];
				html += '<tr><td>' + order.id + '</td><td>' + order.payment + '</td><td>' + order.fee + '</td><td>' + order.status + '</td><td>' + order.op_name + '</td><td>' + order.time + '</td><td><a href="/order/detail/' + order.id + '">查看详情</a></td></tr>';
			}
			html += '</tbody></table>';
			$('#order_history').html(html);
			$('#order_nums').html(orders.length);
		}
		else {
			$('#order_history').html('尚无订购记录！');
			$('#order_nums').html(0);
		}

		var order_items = data.order_items;
		if (!$.isEmptyObject(order_items)) {
			var html = '<table class="table table-bordered table-condensed table-hover table-history"><thead><tr><th>商品名称</th><th>单价</th><th>订购数量</th><th>金额</th></tr></thead><tbody>';
			for (var i in order_items) {
				order_item = order_items[i];
				html += '<tr><td>' + order_item.name + '</td><td>' + order_item.price + '</td><td>' + order_item.quantity + '</td><td>' + order_item.fee + '</td></tr>';
			}
			html += '</tbody></table>';
			$('#order_item_history').html(html);
		}
	});
};
//show_orders();

var show_sms = function () {
	var req = $.ajax({
		url: '{{ url_for('admin.user_sms',user_id=user.user_id) }}',
		dataType: "json",
		cache: false,
		type: 'GET'
	});
	req.done(function (data) {
		var sms_list = data.result;
		if (!$.isEmptyObject(sms_list)) {
			var html = '<table class="table table-bordered table-condensed table-hover table-history"><thead><tr><th>短信内容</th><th>状态</th></tr></thead><tbody>';
			for (var i in sms_list) {
				sms = sms_list[i];
				html += '<tr><td>' + sms.message + '</td><td>' + sms.status + '</td></tr>';
			}
			html += '</tbody></table>';
			$('#sms_history').html(html);
			$('#sms_nums').html(sms_list.length);
		}
		else {
			$('#sms_history').html('无短信记录');
			$('#sms_nums').html(0);
		}
	});
};

//show_sms();

var show_voucher = function () {
	var req = $.ajax({
		url: '{{ url_for('admin.user_voucher',user_id=user.user_id) }}',
		dataType: "json",
		cache: false,
		type: 'GET'
	});
	req.done(function (data) {
		var sms_list = data.result;
		if (!$.isEmptyObject(sms_list)) {
			var html = '<table class="table table-bordered table-condensed table-hover table-history"><thead><tr><th>代金券</th><th>备注</th></tr></thead><tbody>';
			for (var i in sms_list) {
				sms = sms_list[i];
				html += '<tr><td>' + sms.message + '</td><td>' + sms.status + '</td></tr>';
			}
			html += '</tbody></table>';
			$('#voucher_history').html(html);
			$('#voucher_nums').html(sms_list.length);
		}
		else {
			$('#voucher_history').html('无代金券');
			$('#voucher_nums').html(0);
		}
	});
};
//show_voucher();

var show_orderyf = function () {
	var req = $.ajax({
		url: '{{ url_for('admin.user_orderyf',user_id=user.user_id) }}',
		dataType: "json",
		cache: false,
		type: 'GET'
	});
	req.done(function (data) {
		var sms_list = data.result;
		if (!$.isEmptyObject(sms_list)) {
			var html = '<table class="table table-bordered table-condensed table-hover table-history"><thead><tr><th>时间</th><th>大</th><th>中</th><th>小</th><th>芪枣</th></tr></thead><tbody>';
			for (var i in sms_list) {
				sms = sms_list[i];
				html += '<tr><td>' + sms.message + '</td><td>' + sms.bigcount + '</td><td>' + sms.mediumcount + '</td><td>' + sms.smallcount + '</td><td>' + sms.qizaocount + '</td></tr>';
			}
			html += '</tbody></table>';
			$('#orderyf_history').html(html);
			$('#orderyf_nums').html(sms_list.length);
		}
		else {
			$('#orderyf_history').html('无药房复购预判');
			$('#orderyf_nums').html(0);
		}
	});
};
//show_orderyf();

var show_scratchdj = function () {
	var req = $.ajax({
		url: '{{ url_for('admin.user_show_scratchdj',user_id=user.user_id) }}',
		dataType: "json",
		cache: false,
		type: 'GET'
	});
	req.done(function (data) {
		var sms_list = data.result;
		if (!$.isEmptyObject(sms_list)) {
			var html = '<table class="table table-bordered table-condensed table-hover table-history"><thead><tr><th>刮刮卡编码</th><th>登记时间</th><th>操作</th></tr></thead><tbody>';
			for (var i in sms_list) {
				sms = sms_list[i];
				html += '<tr><td>' + sms.qxhcode + '</td><td>' + sms.date + '</td>';
				html += "<td>&nbsp;<a href='#' onclick='scratchdjqx(" + sms.id + ");return false;'>删除</a></td></tr>";
			}
			html += '</tbody></table>';
			$('#scratchdj_list').html(html);
			$('#scratchdj_nums').html(sms_list.length);
		}
		else {
			$('#scratchdj_list').html('无刮刮卡登记');
			$('#scratchdj_nums').html(0);
		}
	});
};

var show_khsldj = function () {
	var req = $.ajax({
		url: '{{ url_for('admin.user_show_khsldj',user_id=user.user_id) }}',
		dataType: "json",
		cache: false,
		type: 'GET'
	});
	req.done(function (data) {
		var sms_list = data.result;
		if (!$.isEmptyObject(sms_list)) {
			var html = '<table class="table table-bordered table-condensed table-hover table-history"><thead><tr><th>空盒编码</th><th>礼品名称</th><th>礼品数量</th><th>购买药房地址</th><th>登记时间</th><th>是否领取</th></tr></thead><tbody>';
			for (var i in sms_list) {
				sms = sms_list[i];
				html += '<tr><td>' + sms.qxhcode + '</td><td>' + sms.giftname + '</td><td>' + sms.giftcount + '</td><td>' + sms.province + sms.city + sms.district + sms.pharmacyaddress + '</td><td>' + sms.date + '</td>';
				html += '<td>';
				if(sms.receive){
					var receives = '已领取';
					if(sms.receive == '2'){
					receives = '拒接换购';
						html += receives;
						if(sms.status){
							html += "&nbsp;<a href='#' onclick='khsldjqx(" + sms.id + ");return false;'>点此取消</a>";
						}
					}else{
						html += receives;
					}
				}else{
					if(!sms.status){
						html += '无效';
					}else{
						html += "未领取&nbsp;<a href='#' onclick='khsllq(" + sms.id + ");return false;'>点此确认客户领取</a>&nbsp;<a href='#' onclick='khsljjlq(" + sms.id + ");return false;'>点此客户拒接换购</a>&nbsp;<a href='#' onclick='khsldjqx(" + sms.id + ");return false;'>点此取消</a>";
					}
				}
				html += "&nbsp;<a href='#' onclick='jjyy(" + sms.id + ");return false;'>未领取原因</a>";
				html += '</td></tr>';
			}
			html += '</tbody></table>';
			$('#khsldj_list').html(html);
			$('#khsldj_nums').html(sms_list.length);
		}
		else {
			$('#khsldj_list').html('无空盒送礼登记');
			$('#khsldj_nums').html(0);
		}
	});
};
//show_khsldj();

var show_fwtjfg = function () {
	var req = $.ajax({
		url: '{{ url_for('admin.user_show_fwtjfg',user_id=user.user_id) }}',
		dataType: "json",
		cache: false,
		type: 'GET'
	});
	req.done(function (data) {
		var sms_list = data.result;
		if (!$.isEmptyObject(sms_list)) {
			var html = '<table class="table table-bordered table-condensed table-hover table-history"><thead><tr><th>时间</th><th>大</th><th>中</th><th>小</th><th>芪枣</th></tr></thead><tbody>';
			for (var i in sms_list) {
				sms = sms_list[i];
				html += '<tr><td>' + sms.message + '</td><td>' + sms.bigcount + '</td><td>' + sms.mediumcount + '</td><td>' + sms.smallcount + '</td><td>' + sms.qizaocount + '</td></tr>';
			}
			html += '</tbody></table>';
			$('#fwtjfg_list').html(html);
			$('#fwtjfg_nums').html(sms_list.length);
		}
		else {
			$('#fwtjfg_list').html('无推荐复购');
			$('#fwtjfg_nums').html(0);
		}
	});
};
//show_fwtjfg();
function jjyy(id){
	$('#jjyyid').val(id);
	$('#jjyyModal').modal('show');return false;
}

var shdz = 0;
var integration = 0;
var lsgmjl = 0;
var sms = 0;
var voucher = 0;
var orderyf = 0;
var khsldj = 0;
var fwtjfg = 0;
var scratchdj = 0;
//$('a#addressModule').click(show);
function show(id) {
//	alert(this);
	if(id == 'shdz'){
		if(shdz){
		}else{
			shdz = 1;
			show_shipping_address();
		}
	}
	if(id == 'integration'){
		if(integration){
		}else{
			integration = 1;
			show_integration();
		}
	}
	if(id == 'lsgmjl'){
		if(lsgmjl){
		}else{
			lsgmjl = 1;
			show_orders();
		}
	}
	if(id == 'sms'){
		if(sms){
		}else{
			sms = 1;
			show_sms();
		}
	}
	if(id == 'voucher'){
		if(voucher){
		}else{
			voucher = 1;
			show_voucher();
		}
	}
	if(id == 'orderyf'){
		if(orderyf){
		}else{
			orderyf = 1;
			show_orderyf();
		}
	}
	if(id == 'khsldj'){
		if(khsldj){
		}else{
			khsldj = 1;
			show_khsldj();
		}
	}
	if(id == 'fwtjfg'){
		if(fwtjfg){
		}else{
			fwtjfg = 1;
			show_fwtjfg();
		}
	}
	if(id == 'scratchdj'){
		if(scratchdj){
		}else{
			scratchdj = 1;
			show_scratchdj();
		}
	}
}
</script>
{% endblock %}


{% block sidebar -%}
    {{ super() }}
    <div style="font-size:12px;line-height: 18px;margin-top: 30px;text-align: right">
        {% for log in assign_logs %}
            <div style="border-bottom: #cccccc dashed 1px;margin-bottom: 8px;padding-right: 5px">{{ assign_log_output(log) }}</div>
        {% endfor %}
    </div>
{% endblock %}